{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/job.schema.json",
  "title": "Multi-Agent CLI Orchestrator JobSpec",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "job_id",
    "created_at",
    "goal",
    "workdir",
    "steps",
    "policy"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0"
    },
    "job_id": {
      "type": "string",
      "pattern": "^[a-f0-9]{32}$|^[a-zA-Z0-9._-]{8,64}$"
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "source": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "webhook",
            "manual",
            "cron"
          ]
        },
        "meta": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "goal": {
      "type": "string",
      "minLength": 1,
      "maxLength": 5000
    },
    "project_id": {
      "type": [
        "string",
        "null"
      ],
      "minLength": 1,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9][A-Za-z0-9._-]{0,127}$"
    },
    "workdir": {
      "type": "string",
      "minLength": 1,
      "maxLength": 4096
    },
    "callback_url": {
      "type": ["string", "null"],
      "format": "uri",
      "maxLength": 2048,
      "description": "URL to POST job result to upon completion"
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "default": []
    },
    "metadata": {
      "type": "object",
      "additionalProperties": true,
      "default": {}
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "step_id",
          "agent",
          "role",
          "prompt"
        ],
        "properties": {
          "step_id": {
            "type": "string",
            "pattern": "^[0-9A-Za-z][0-9A-Za-z_-]{0,63}$"
          },
          "agent": {
            "type": "string"
          },
          "role": {
            "type": "string",
            "minLength": 1,
            "maxLength": 128
          },
          "prompt": {
            "type": "string",
            "minLength": 1,
            "maxLength": 20000
          },
          "timeout_sec": {
            "type": "integer",
            "minimum": 1,
            "maximum": 3600,
            "default": 600
          },
          "max_retries": {
            "type": "integer",
            "minimum": 0,
            "maximum": 10,
            "default": 1
          },
          "retry_backoff_sec": {
            "type": "integer",
            "minimum": 0,
            "maximum": 60,
            "default": 2
          },
          "input_artifacts": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "default": []
          },
          "apply_patches_from": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "default": []
          },
          "allowed_tools": {
            "type": ["array", "null"],
            "items": {
              "type": "string"
            }
          },
          "on_failure": {
            "type": "string",
            "pattern": "^(stop|continue|goto:[0-9A-Za-z][0-9A-Za-z_-]{0,63})$",
            "default": "stop",
            "description": "Failure strategy: 'stop' halts pipeline, 'continue' proceeds, 'goto:<step_id>' jumps to named step"
          }
        }
      }
    },
    "policy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "sandbox",
        "network",
        "allowed_binaries"
      ],
      "properties": {
        "sandbox": {
          "type": "boolean",
          "default": true
        },
        "network": {
          "type": "string",
          "enum": [
            "deny",
            "allow"
          ],
          "default": "deny"
        },
        "allowed_binaries": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "requires_approval": {
          "type": "boolean",
          "default": false
        }
      }
    }
  }
}
